{% extends "base/base.html" %}
{% block title %}Your Reviews{% endblock %}

<!-- Hide footer on reviews page -->
{% block footer %}{% endblock %}

{% block start %} {% load static %}

<div class="container mt-4">
  <h3 class="form-group mb-4">Product Reviews</h3>
</div>

<div class="container my-3 p-4 rounded">
  {% include 'base/alert.html' %}
  {% if reviews %}
  <div class="row">
    {% for review in reviews %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card h-100 shadow-sm rounded">
        <div class="row g-0 align-items-center">
          <!-- Product Image -->
          <div class="col-4">
            <img src="{{ review.product.product_images.first.image_url }}" class="img-fluid rounded-start"
              alt="{{ review.product.product_name }}" style="width: 100%; height: auto; object-fit: cover" />
          </div>

          <!-- Review Details -->
          <div class="col-8">
            <div class="card-body">
              <h5 class="card-title">
                <a href="{% url 'get_product' review.product.slug %}" class="text-decoration-none">
                  {{ review.product.product_name }}
                </a>
              </h5>
              <small class="text-muted">Posted on {{ review.date_added|date:"M d, Y" }}</small>
              <p class="mt-2"><strong>Rating:</strong> {{ review.stars }}/5</p>
              <p class="card-text" title="{{ review.content }}">
                <strong>Comment:</strong> {{ review.content|truncatechars:50 }}
              </p>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center"
            style="width: 45%; border-radius: 30px; font-weight: 500" data-bs-toggle="modal"
            data-bs-target="#editReviewModal" data-review-id="{{ review.uid }}" data-review-stars="{{ review.stars }}"
            data-review-content="{{ review.content }}">
            <i class="bi bi-pencil-square me-1"></i> Edit
          </button>
          <form method="POST" action="{% url 'delete_review' review.product.slug review.uid %}"
            style="display: inline; width: 45%">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center"
              style="width: 100%; border-radius: 30px; font-weight: 500" data-bs-toggle="modal"
              data-bs-target="#deleteReviewModal"
              onclick="setDeleteAction('{% url 'delete_review' review.product.slug review.uid %}')" type="button">
              <i class="bi bi-trash-fill me-1"></i> Delete
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-5">
    <div class="empty-state-container">
      <div class="empty-state-icon mb-4">
        <i class="fas fa-star" style="font-size: 4rem; color: #e2e8f0;"></i>
      </div>
      <h3 class="empty-state-title mb-3" style="color: #64748b; font-weight: 600;">No Reviews Yet</h3>
      <p class="empty-state-subtitle mb-4" style="color: #94a3b8; font-size: 1.1rem;">
        You haven't written any product reviews yet. Start shopping and share your experience with others.
      </p>
      <a href="{% url 'index' %}" class="btn btn-primary btn-lg px-4 py-2 start-shopping-btn">
        <i class="fas fa-shopping-bag me-2"></i>Start Shopping
      </a>
    </div>
  </div>
  {% endif %}

  <!-- Delete Review Confirmation Modal -->
  <div class="modal fade" id="deleteReviewModal" tabindex="-1" aria-labelledby="deleteReviewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteReviewModalLabel">
            Confirm Delete
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this product review?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <form id="deleteReviewForm" method="POST" style="display: inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-primary delete-review-btn">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Review Modal -->
  <div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editReviewModalLabel">Edit Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editReviewForm" method="POST">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="editStars" class="form-label">Rating</label>
              <input type="number" class="form-control" id="editStars" name="stars" min="1" max="5" required />
            </div>
            <div class="mb-3">
              <label for="editContent" class="form-label">Content</label>
              <textarea class="form-control" id="editContent" name="content" rows="4" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const editReviewModal = document.getElementById("editReviewModal");
    editReviewModal.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      const reviewId = button.getAttribute("data-review-id");
      const reviewStars = button.getAttribute("data-review-stars");
      const reviewContent = button.getAttribute("data-review-content");

      const starsInput = editReviewModal.querySelector("#editStars");
      const contentTextarea = editReviewModal.querySelector("#editContent");
      const form = editReviewModal.querySelector("#editReviewForm");

      starsInput.value = reviewStars;
      contentTextarea.value = reviewContent;
      form.action = "/product/product-reviews/edit/" + reviewId + "/";
    });
  });

  function setDeleteAction(actionUrl) {
    const deleteForm = document.getElementById("deleteReviewForm");
    deleteForm.action = actionUrl;
  }
</script>

<style>
  /* Unified Color System */
  :root {
    --primary-color: #6366f1;
    --accent-color: #fbbf24;
    --text-dark: #1e293b;
  }

  .delete-review-btn {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transition: all 0.3s ease;
  }

  .delete-review-btn:hover {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: var(--text-dark);
  }

  .start-shopping-btn {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    transition: all 0.3s ease;
  }

  .start-shopping-btn:hover {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    color: var(--text-dark);
  }
</style>

{% endblock %}